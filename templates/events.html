<!DOCTYPE html>
<html>
<head>
    <title>Activity – {{ date_str }}</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            padding: 24px;
            background: #f3f4f6;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        h2 {
            margin: 0;
            font-size: 22px;
            color: #111827;
        }
        .logout {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }

        .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 14px 16px;
            box-shadow: 0 1px 6px rgba(15, 23, 42, 0.08);
            margin-bottom: 18px;
        }

        .date-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .date-form input[type="date"] {
            padding: 4px 8px;
        }
        .date-form button {
            padding: 4px 10px;
            border-radius: 6px;
            border: none;
            background: #2563eb;
            color: white;
            cursor: pointer;
        }

        /* TIMELINE */
        .timeline-wrapper {
            margin-top: 6px;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .timeline-title {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
        }
        .timeline-bar {
            position: relative;
            height: 26px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
        }
        .timeline-block {
            position: absolute;
            top: 2px;
            bottom: 2px;
            border-radius: 999px;
            opacity: 0.9;
            font-size: 8px;
        }
        .timeline-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
            font-size: 11px;
            color: #374151;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* SUMMARY TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #1d4ed8;
            color: #f9fafb;
            font-weight: 600;
        }
        tr:nth-child(even) td {
            background: #f9fafb;
        }

        .section {
            margin-top: 10px;
        }

        details summary {
            font-size: 15px;
            cursor: pointer;
            padding: 6px 10px;
            background: #e0ecff;
            border-radius: 6px;
            margin-bottom: 10px;
            list-style: none;
        }
        details summary::-webkit-details-marker {
            display: none;
        }

        .bulk-bar {
            margin: 10px 0;
            background: #f9fafb;
            padding: 8px 10px;
            border-radius: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid #e5e7eb;
        }

        select, input[type="text"] {
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 12px;
        }

        .update-btn, .undo-btn {
            padding: 5px 9px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .update-btn {
            background: #16a34a;
            color: white;
        }
        .undo-btn {
            background: #ef4444;
            color: white;
        }

        /* Duration coloring */
        .dur-short {
            color: #16a34a;
        }
        .dur-medium {
            color: #ea580c;
        }
        .dur-long {
            color: #b91c1c;
            font-weight: 600;
        }

        /* Column filter row */
        .filter-row input {
            width: 100%;
            box-sizing: border-box;
            font-size: 11px;
        }

        .small-label {
            font-size: 11px;
            color: #6b7280;
        }
    </style>

    <script>
        // ------------------------
        // SELECT ALL / BULK ACTIONS
        // ------------------------
        function toggleSelectAll(section, check) {
            document.querySelectorAll("." + section + " .ev-check").forEach(cb => {
                cb.checked = check;
            });
        }

        function bulkSubmit(route, section) {
            let ids = [];
            document.querySelectorAll("." + section + " .ev-check:checked").forEach(cb => {
                ids.push(parseInt(cb.value));
            });

            if (ids.length === 0) {
                alert("No events selected.");
                return;
            }

            const form = document.getElementById(section + "-bulk-form");
            form.querySelector("input[name='event_ids']").value = JSON.stringify(ids);
            form.action = route;
            form.submit();
        }

        // ------------------------
        // COLUMN FILTERING
        // ------------------------
        function filterTable(section) {
            const table = document.querySelector("table." + section);
            if (!table) return;

            const filterRow = table.querySelector(".filter-row");
            if (!filterRow) return;

            const inputs = filterRow.querySelectorAll("input[data-col]");
            const filters = {};
            inputs.forEach(inp => {
                const col = parseInt(inp.dataset.col);
                filters[col] = inp.value.toLowerCase();
            });

            const rows = table.querySelectorAll("tbody tr.data-row");
            rows.forEach(row => {
                let visible = true;
                Object.keys(filters).forEach(colIdxStr => {
                    const colIdx = parseInt(colIdxStr);
                    const needle = filters[colIdx];
                    if (!needle) return;
                    const cell = row.children[colIdx];
                    if (!cell) return;
                    const text = (cell.innerText || "").toLowerCase();
                    if (!text.includes(needle)) {
                        visible = false;
                    }
                });
                row.style.display = visible ? "" : "none";
            });
        }

        // ------------------------
        // TIMELINE RENDERING
        // ------------------------
        document.addEventListener("DOMContentLoaded", function () {
            const blocks = {{ timeline_blocks|tojson }};
            const bar = document.getElementById("timeline-bar");
            const legend = document.getElementById("timeline-legend");

            if (!bar || !blocks || blocks.length === 0) {
                bar.innerHTML = "<div style='font-size:12px;color:#6b7280;padding:4px 8px;'>No activity for this day.</div>";
                return;
            }

            function parseISO(s) { return new Date(s); }

            let minStart = null;
            let maxEnd = null;
            blocks.forEach(b => {
                const s = parseISO(b.start).getTime();
                const e = parseISO(b.end).getTime();
                if (minStart === null || s < minStart) minStart = s;
                if (maxEnd === null || e > maxEnd) maxEnd = e;
            });

            const total = Math.max(1, maxEnd - minStart);

            const palette = [
                "#4f46e5", "#16a34a", "#f97316", "#0ea5e9",
                "#ec4899", "#22c55e", "#8b5cf6", "#facc15",
                "#14b8a6", "#f97373", "#64748b"
            ];
            const colorMap = {};
            let idx = 0;

            blocks.forEach(b => {
                const proj = b.project || "Unassigned";
                if (!colorMap[proj]) {
                    colorMap[proj] = palette[idx % palette.length];
                    idx++;
                }
            });

            blocks.forEach(b => {
                const s = parseISO(b.start).getTime();
                const e = parseISO(b.end).getTime();
                const leftPct = ((s - minStart) / total) * 100;
                const widthPct = ((e - s) / total) * 100;

                const div = document.createElement("div");
                div.className = "timeline-block";
                div.style.left = leftPct + "%";
                div.style.width = Math.max(widthPct, 0.5) + "%";
                div.style.backgroundColor = colorMap[b.project] || "#9ca3af";
                div.title = `${b.project || "Unassigned"} • ${b.app} • ${b.title} (${b.duration_min} min)`;

                bar.appendChild(div);
            });

            Object.entries(colorMap).forEach(([project, color]) => {
                const item = document.createElement("div");
                item.className = "legend-item";
                item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${project}`;
                legend.appendChild(item);
            });
        });

        // ------------------------
        // DURATION CLASS (used inline)
        // ------------------------
        function durationClass(hours) {
            if (hours < 0.25) return "dur-short";
            if (hours < 2) return "dur-medium";
            return "dur-long";
        }
    </script>
</head>
<body>

<div class="top-bar">
    <h2>Tracked Activity — {{ date_str }}</h2>
    <a class="logout" href="/logout">Logout</a>
</div>

<div class="card">
    <form method="get" class="date-form">
        <span class="small-label">Date:</span>
        <input type="date" name="date" value="{{ date_str }}">
        <button type="submit">Go</button>
        <a href="/export_csv/today" style="margin-left:auto;font-size:12px;">Download CSV</a>
    </form>
</div>

<!-- TIMELINE -->
<div class="card timeline-wrapper">
    <div class="timeline-header">
        <div class="timeline-title">Day Timeline (colored by project)</div>
    </div>
    <div class="timeline-bar" id="timeline-bar"></div>
    <div class="timeline-legend" id="timeline-legend"></div>
</div>

<!-- SUMMARY -->
<div class="card">
    <h3 style="margin-top:0;font-size:15px;">Project Summary</h3>
    <table>
        <thead>
            <tr>
                <th>Project</th>
                <th>Hours</th>
            </tr>
        </thead>
        <tbody>
        {% for p, hrs in summary.items() %}
            <tr>
                <td>{{ p }}</td>
                <td>{{ "%.2f"|format(hrs) }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- UNASSIGNED -->
<div class="section">
<div class="card">
<details open>
    <summary>Unassigned Activities ({{ unassigned|length }})</summary>

    <div class="bulk-bar unassigned">
        <label><input type="checkbox" onclick="toggleSelectAll('unassigned', this.checked)"> Select All</label>

        <form id="unassigned-bulk-form" method="POST">
            <input type="hidden" name="event_ids">

            <span class="small-label">Assign to:</span>
            <select name="bulk_project_id">
                {% for p in projects %}
                <option value="{{ p[0] }}">{{ p[1] }}</option>
                {% endfor %}
            </select>

            <button type="button" onclick="bulkSubmit('/bulk_update', 'unassigned')" class="update-btn">Bulk Assign</button>
            <button type="button" onclick="bulkSubmit('/bulk_undo', 'unassigned')" class="undo-btn">Bulk Undo</button>
        </form>
    </div>

    <table class="unassigned">
        <thead>
            <tr>
                <th></th>
                <th>Start</th>
                <th>End</th>
                <th>Hours</th>
                <th>App</th>
                <th>Window</th>
                <th>Assign</th>
                <th>Undo</th>
            </tr>
            <tr class="filter-row">
                <td></td>
                <td><input type="text" placeholder="Filter…" data-col="1" onkeyup="filterTable('unassigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="2" onkeyup="filterTable('unassigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="3" onkeyup="filterTable('unassigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="4" onkeyup="filterTable('unassigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="5" onkeyup="filterTable('unassigned')"></td>
                <td></td>
                <td></td>
            </tr>
        </thead>
        <tbody>
        {% for e in unassigned %}
            <tr class="data-row">
                <td><input type="checkbox" class="ev-check" value="{{ e[0] }}"></td>
                <td>{{ e[1] }}</td>
                <td>{{ e[2] }}</td>
                {% set hrs = e[6] %}
                {% set cls = 'dur-short' %}
                {% if hrs >= 0.25 and hrs < 2 %}
                    {% set cls = 'dur-medium' %}
                {% elif hrs >= 2 %}
                    {% set cls = 'dur-long' %}
                {% endif %}
                <td class="{{ cls }}">{{ "%.2f"|format(hrs) }}</td>
                <td>{{ e[3] }}</td>
                <td>{{ e[4] }}</td>

                <td>
                    <form method="POST" action="/update" style="display:flex; gap:4px;">
                        <input type="hidden" name="event_id" value="{{ e[0] }}">
                        <select name="project_id">
                            {% for p in projects %}
                            <option value="{{ p[0] }}">{{ p[1] }}</option>
                            {% endfor %}
                        </select>
                        <button class="update-btn">✔</button>
                    </form>
                </td>

                <td>
                    <form method="POST" action="/undo">
                        <input type="hidden" name="event_id" value="{{ e[0] }}">
                        <button class="undo-btn">↺</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</details>
</div>
</div>

<!-- ASSIGNED -->
<div class="section">
<div class="card">
<details>
    <summary>Assigned Activities ({{ assigned|length }})</summary>

    <div class="bulk-bar assigned">
        <label><input type="checkbox" onclick="toggleSelectAll('assigned', this.checked)"> Select All</label>

        <form id="assigned-bulk-form" method="POST">
            <input type="hidden" name="event_ids">

            <span class="small-label">Reassign to:</span>
            <select name="bulk_project_id">
                {% for p in projects %}
                <option value="{{ p[0] }}">{{ p[1] }}</option>
                {% endfor %}
            </select>

            <button type="button" onclick="bulkSubmit('/bulk_update', 'assigned')" class="update-btn">Bulk Reassign</button>
            <button type="button" onclick="bulkSubmit('/bulk_undo', 'assigned')" class="undo-btn">Bulk Undo</button>
        </form>
    </div>

    <table class="assigned">
        <thead>
            <tr>
                <th></th>
                <th>Project</th>
                <th>Start</th>
                <th>End</th>
                <th>Hours</th>
                <th>App</th>
                <th>Window</th>
                <th>Reassign</th>
                <th>Undo</th>
            </tr>
            <tr class="filter-row">
                <td></td>
                <td><input type="text" placeholder="Filter project…" data-col="1" onkeyup="filterTable('assigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="2" onkeyup="filterTable('assigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="3" onkeyup="filterTable('assigned')"></td>
                <td><input type="text" placeholder="Filter…" data-col="4" onkeyup="filterTable('assigned')"></td>
                <td><input type="text" placeholder="Filter app…" data-col="5" onkeyup="filterTable('assigned')"></td>
                <td><input type="text" placeholder="Filter window…" data-col="6" onkeyup="filterTable('assigned')"></td>
                <td></td>
                <td></td>
            </tr>
        </thead>
        <tbody>
        {% for e in assigned %}
            <tr class="data-row">
                <td><input type="checkbox" class="ev-check" value="{{ e[0] }}"></td>
                <td>{{ e[5] }}</td>
                <td>{{ e[1] }}</td>
                <td>{{ e[2] }}</td>
                {% set hrs = e[6] %}
                {% set cls = 'dur-short' %}
                {% if hrs >= 0.25 and hrs < 2 %}
                    {% set cls = 'dur-medium' %}
                {% elif hrs >= 2 %}
                    {% set cls = 'dur-long' %}
                {% endif %}
                <td class="{{ cls }}">{{ "%.2f"|format(hrs) }}</td>
                <td>{{ e[3] }}</td>
                <td>{{ e[4] }}</td>

                <td>
                    <form method="POST" action="/update" style="display:flex; gap:4px;">
                        <input type="hidden" name="event_id" value="{{ e[0] }}">
                        <select name="project_id">
                            {% for p in projects %}
                            <option value="{{ p[0] }}">{{ p[1] }}</option>
                            {% endfor %}
                        </select>
                        <button class="update-btn">✔</button>
                    </form>
                </td>

                <td>
                    <form method="POST" action="/undo">
                        <input type="hidden" name="event_id" value="{{ e[0] }}">
                        <button class="undo-btn">↺</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</details>
</div>
</div>

</body>
</html>
